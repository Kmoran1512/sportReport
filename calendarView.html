<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>Sport Report</title>

    <link href='./fullcalendar-4/packages/core/main.css' rel='stylesheet' />
    <link href='./fullcalendar-4/packages/daygrid/main.css' rel='stylesheet' />
    <link href='./calendarStyles.css' rel='stylesheet' />
    <link href='./colorSlider.css' rel='stylesheet' />


    <script src='./fullcalendar-4/packages/core/main.js'></script>
    <script src='./fullcalendar-4/packages/daygrid/main.js'></script>
    <script src='./fullcalendar-4/packages/interaction/main.js'></script>
    <script src='./fullcalendar-4/packages/google-calendar/main.js'></script>
    <script src='./node_modules/jquery/dist/jquery.js'></script>
    <script src='./node_modules/axios/dist/axios.js'></script>

    <script>

      let selectedDate = "";

      document.addEventListener('DOMContentLoaded', function() {
        let calendarEl = document.getElementById('calendar');   

        let calendar = new FullCalendar.Calendar(calendarEl, {
          plugins: [ 'dayGrid', 'interaction', 'googleCalendar'],
        
          height: $(document).height()-20,

          header: {
            center: 'addEventButton'
         },
         googleCalendarApiKey: 'AIzaSyB4It3AW2oTsPwnNDXHQ1rIi_aqlJwpRAM',
        events: {
            googleCalendarId: localStorage.getItem("calendarEmail"),
        },
        customButtons: {
        addEventButton: {
            text: 'Add Practices',
            click: function() {
                  document.getElementById("myModal").style.display = "block";
                }
            }
        },

          fixedWeekCount: false,

          eventClick: function(info) {
                info.jsEvent.cancelBubble = true;
                info.jsEvent.preventDefault();
                openFeedback(info);
            }
        });

        calendar.render();
        loadColor();
      });

      let userPermissions;
      let userClub;
      
      let getUserPermissions = async function(){

        let response = await axios({
                    method: 'GET',
                    headers: {
                      'Authorization': 'Bearer ' + localStorage.getItem('jwtKey'),
                    },
                    url: "http://localhost:3000/account/status" ,
          }
          );

        let user = localStorage.getItem('username');
                
        userPermission = response.data.user.data.permission;
        userClub = response.data.user.data.clubName;

      }

      getUserPermissions();

       // When the user clicks on <span> (x), close the modal
   let closeModal = function() {
    document.getElementsByClassName("close")[0].onclick = function() {
      document.getElementById("myModal").style.display = "none";
    }
  }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == document.getElementById("myModal")) {
        document.getElementById("myModal").style.display = "none";
      }
    } 


      /*

      Bugs with Feedback window:
      - When saved adds feedback twice
      - Can't overwrite existing feedback, will just add another one
      - Will always pick first feedback written when selecting a day with multiple feedbacks existing
      - Errors with new users, problem when merging dataStore when empty... (on first time don't merge?)
      */

    async function loadColor() {
      //Set past background color
      try {
        let response = [0];
        response = await axios({
                  method: 'GET',
                  headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtKey'),
                  },
                  url: "http://localhost:3000/private/data/DataStore/",
        });

        qs('#calendar').style.backgroundColor = response.data;
        console.log(response.data.getRed());
        qs('#red').value = response.data.getRed();

      } catch {

      }
    }

    async function openFeedback(info) {

      selectedDate = info.event.start.valueOf(); //SETS DATE BEING EDITED
      
      console.log(selectedDate);

      let response = [0];
      console.log("Retreive feedback from user.json");
      
      try {
        response = await axios({
                  method: 'GET',
                  headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtKey'),
                  },
                  url: "http://localhost:3000/user/data/DataStore/"+selectedDate,
        });

        let existingFeedback = response.data.result.feedback;
            
        if (existingFeedback != "") {
          document.getElementById("feedbackForm").value = existingFeedback;
        }
        document.getElementById("myForm").style.display = "block";
        document.getElementById("workoutTitle").textContent = "Today's Workout (" + info.event.start.toLocaleDateString("en-US") + ")";

      } catch {
        document.getElementById("myForm").style.display = "block";
        document.getElementById("workoutTitle").textContent = "Today's Workout (" + info.event.start.toLocaleDateString("en-US") + ")";
      }
        
    }

    function closeFeedback(info) {
      document.getElementById("myForm").style.display = "none";
    }

    async function saveFeedback(info) {
      if (document.getElementById("feedbackForm").value != "") {
        
        //console.log(localStorage.getItem('jwtKey')); (Get JWT Key)

        let response = [0];
        console.log("Post Feedback to user.json");
        response = await axios({
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + localStorage.getItem('jwtKey'),
                },
                url: "http://localhost:3000/user/data/DataStore/" + selectedDate,
                data: {
                  "data": {
                    "date" : selectedDate, "feedback" : document.getElementById("feedbackForm").value
                  }, 
                },
        });
        closeFeedback();
        //Set past background color
      try {
        let response = [0];
        response = await axios({
                  method: 'GET',
                  headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtKey'),
                  },
                  url: "http://localhost:3000/private/data/DataStore/",
        });

        qs('#calendar').style.backgroundColor = response.data;
      } catch {

      }
      }
    }

    async function submitCalendarEmail(){
      if(userPermission == "Coach"){
        response = await axios({
                method: 'POST',
                url: "http://localhost:3000/public/clubs/" + userClub,
                data: {
                  "data": {
                    "email" : document.getElementById("calendarEmailTextArea").value,
                  }, 
                },
        });

        localStorage.setItem("calendarEmail",  document.getElementById("calendarEmailTextArea").value);
        document.getElementById("myModal").style.display = "none";
        location.reload();
      }
    }


    </script>
  </head>
  <body>

    <!-- The Modal -->
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close" onclick=closeModal()>&times;</span>
      <h1>How To Link Your Google Calendar</h1>
      <p id = "calendarLinkText">1. Open settings of your calendar </p>
      <p id = "calendarLinkText">2. Scroll down to access permissions</p>
      <p id = "calendarLinkText">3. Click the box make available to public</p>
      <p id = "calendarLinkText">4. Type in gmail email linked to the goolge calendar and press submit:</p>
      <p id = "calendarLinkText">Warning: You must be a coach to change calendar</p>

      <form id=calendarInputWrapper>
        <input id=calendarEmailTextArea></input>
        <button type="button" id="calendarEmailButton" onclick=submitCalendarEmail()>Submit</button>
      </form>
      
      </div>
    </div>

      <div class="form-popup" id="myForm">
        <form class="form-container">
          <h1 id="workoutTitle">Today's Workout</h1>

          <label class="feedbackLabel" for="feedback"><b>Feedback</b></label>
          <textarea id="feedbackForm" type="text" placeholder="Enter Feedback" name="feedback" required></textarea>
      
          <button class="btn" onclick="saveFeedback()">Save Feedback</button>
          <button type="button" class="btn cancel" onclick="closeFeedback()">Cancel</button>
        </form>
      </div>


        <div>
            <div class="color-slider-wrap">
                <div class="color-wrap">
                </div>
                <div class="sliders">
                    <div>
                        <label for="red">Red</label>
                        <input type="number" id="redNum">
                        <input value="128" type="range" min="0" max="255" id="red">
                    </div>
                    <div>
                        <label for="green">Green</label>
                        <input type="number" id="greenNum">
                        <input value="128" type="range" min="0" max="255" id="green">
                    </div>
                    <div>
                        <label for="blue">Blue</label>
                        <input type="number" id="blueNum">
                        <input value="0" type="range" min="0" max="255" id="blue">
                    </div>
                </div>
            </div>
        </div>
        
        <div id='calendar'></div>
        <script src="colorSlider.js"></script>
  </body>
</html>